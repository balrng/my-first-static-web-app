<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles.css">
    <title>Vanilla JavaScript App</title>
</head>

<body>
    <main>
        <h1>Vanilla JavaScript App</h1>
        <p>Loading content from the Azure API(https://agreeable-bush-0b398a403.4.azurestaticapps.net/api/message): <b
                id="name">...</b></p>
    </main>


    <script>
        (async function () {
            const { message } = await (await fetch(`api/message`)).json();
            document.querySelector('#name').textContent = message;
        }());
    </script>


    <main>
        <h1>Static Web Apps Cosmos No-SQL Database Connections</h1>
        <p>Click to call cosmos db API to begin operations</p>
        <div>
            <button id="list" onclick="list()">List</button>
            <button id="get" onclick="get()">Get</button>
            <button id="update" onclick="update()">Update</button>
            <button id="create" onclick="create()">Create</button>
            <button id="delete" onclick="del()">Delete</button>
        </div>
        </br>
        <table id="resultTable" border="1">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                </tr>
            </thead>
            <tbody>
                <!-- Sonuçlar buraya eklenecek -->
            </tbody>
        </table>
    </main>

    <script>
        function updateTable(items) {
            const tableBody = document.querySelector("#resultTable tbody");
            tableBody.innerHTML = ""; // Önce tabloyu temizler

            items.forEach(item => {
                const row = document.createElement("tr");
                const idCell = document.createElement("td");
                const nameCell = document.createElement("td");

                idCell.textContent = item.id || "-";
                nameCell.textContent = item.Name || "-";

                row.appendChild(idCell);
                row.appendChild(nameCell);
                tableBody.appendChild(row);
            });
        }


        async function list() {

            const query = `
                        {
                        people {
                            items {
                            id
                            Name
                            }
                        }
                        }`;

            const endpoint = "/data-api/graphql";
            const response = await fetch(endpoint, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ query: query })
            });
            const result = await response.json();
            console.table(result.data.people.items);

            updateTable(result.data.people.items);
            return result.data.people.items;
        }

        async function get() {

            const id = '1';

            const gql = `
            query getById($id: ID!) {
                person_by_pk(id: $id) {
                id
                Name
                }
            }`;

            const query = {
                query: gql,
                variables: {
                    id: id,
                },
            };

            const endpoint = "/data-api/graphql";
            const response = await fetch(endpoint, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(query),
            });
            const result = await response.json();
            console.table(result.data.person_by_pk);
            updateTable([result.data.person_by_pk]);
        }

        async function update() {

            const id = '1';
            const data = {
                id: id,
                Name: "Molly"
            };

            const gql = `
            mutation update($id: ID!, $_partitionKeyValue: String!, $item: UpdatePersonInput!) {
                updatePerson(id: $id, _partitionKeyValue: $_partitionKeyValue, item: $item) {
                id
                Name
                }
            }`;

            const query = {
                query: gql,
                variables: {
                    id: id,
                    _partitionKeyValue: id,
                    item: data
                }
            };

            const endpoint = "/data-api/graphql";
            const res = await fetch(endpoint, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(query)
            });

            const result = await res.json();
            console.table(result.data.updatePerson);
        }

        async function create() {
            // Mevcut verileri al
            const items = await list();

            // Mevcut verilerden en büyük ID'yi bul
            const maxId = Math.max(...items.map(item => parseInt(item.id, 10)), 0);

            // Yeni ID'yi oluştur
            const newId = (maxId + 1).toString();

            // Yeni veriyi oluştur
            const data = {
                id: newId,
                Name: `Person ${newId}`
            };

            const gql = `
                                mutation create($item: CreatePersonInput!) {
                                    createPerson(item: $item) {
                                        id
                                        Name
                                    }
                                }`;

            const query = {
                query: gql,
                variables: { item: data }
            };

            const endpoint = "/data-api/graphql";
            const createResponse = await fetch(endpoint, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(query)
            });

            const createResult = await createResponse.json();
            console.table(createResult.data.createPerson);

            // Tabloyu güncelle (yeni veriyi ekle)
            updateTable([...items, createResult.data.createPerson]);
        }


        async function del() {

            const id = '3';

            const gql = `
            mutation del($id: ID!, $_partitionKeyValue: String!) {
                deletePerson(id: $id, _partitionKeyValue: $_partitionKeyValue) {
                id
                }
            }`;

            const query = {
                query: gql,
                variables: {
                    id: id,
                    _partitionKeyValue: id
                }
            };

            const endpoint = "/data-api/graphql";
            const response = await fetch(endpoint, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(query)
            });

            const result = await response.json();
            console.log(`Record deleted: ${JSON.stringify(result.data)}`);
        }

        const endpoint = "/data-api/graphql";
        const result = await fetch(endpoint, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(query)
        });

        const response = await result.json();
        console.table(response.data.createPerson);
        }

    </script>

</body>

</html>